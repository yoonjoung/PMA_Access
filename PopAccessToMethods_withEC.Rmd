---
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
---

```{r intro, echo=FALSE, results="hide"}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      comment = "", 
                      warning=FALSE, 
                      results="hide") 
knitr::opts_knit$set(root.dir = "C:/Users/YoonJoung Choi/Dropbox/0 iSquared/iSquared_PMA/Effective Access/")

date<-as.Date(Sys.time(	), format='%d%b%Y')
time<-Sys.time()

suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressMessages(library(plotly))
suppressMessages(library(stringr))
suppressMessages(library(stringi))

```

```{r dtaSDP}
#Survey-level link summary data, constructed from Stata
dtaSDP<-read.csv("summary_Access_Indicators_SR.csv")%>%
    #filter(xsurvey!="NENiameyR5" & xsurvey!="BFR6" & xsurvey!="NGKanoR3")%>%
    filter(country!="Niger, Niamey" & country!="Nigeria, Lagos" & country!="Nigeria, Kano")%>%
    group_by(country)%>%
    mutate(latest=round==max(round))%>%
    ungroup()%>%
    #filter(countrycode!="NE" & countrycode!="NG")%>%
    mutate(
        month = ifelse(month==0, 12, month), 
        yearmonth = ISOdate(year, month, 15),
        essential5_offer=round(essential5_offer, 0),
        essential5_curav=round(essential5_curav, 0),
        essential5_noso =round(essential5_noso, 0),
        essential5_ready=round(essential5_ready, 0),
        essential5_rnoso=round(essential5_rnoso, 0),
        
        essential5ec_offer=round(essential5ec_offer, 0),
        essential5ec_curav=round(essential5ec_curav, 0),
        essential5ec_noso =round(essential5ec_noso, 0),
        essential5ec_ready=round(essential5ec_ready, 0),
        essential5ec_rnoso=round(essential5ec_rnoso, 0)
    )
    
    #table(dtaSDP$country)
    #table(dtaSDP$xsurvey)
    
#temp<-dtaSDP%>%filter(latest==TRUE)
    #table(temp$country)
    #table(temp$xsurvey)

nrow(dtaSDP)
length(unique(dtaSDP$country)) 
length(unique(dtaSDP$xsurvey)) 
table(dtaSDP$group)
```

```{r dtaIR}
dtaIR<-data.frame(read_csv("summary_Access_Indicators_IR_PopAccessToMethods.csv"))%>%
    filter(xsurvey!="NENiameyR5" & xsurvey!="BFR6" & xsurvey!="NGKanoR3")%>%
    filter(country!="Niger, Niamey" & country!="Nigeria, Lagos" & country!="Nigeria, Kano")%>%
    filter(year<=2018)%>%
    mutate(month = ifelse(month==0, 12, month), 
           yearmonth = ISOdate(year, month, 15)
           #yearmonth = as.POSIXct(as.numeric(yearmonth), origin="1970-01-01"), 
           #yearmonth = substr(as.character(yearmonth),0,7), 
           )%>%
    group_by(country)%>%
    mutate(latestIRLINK=round==max(round))%>%
    ungroup()
    #filter(countrycode!="NE" & countrycode!="NG")
    
    #table(dtaIR$country)
    #table(dtaIR$xsurvey)

#temp<-dtaIR%>%filter(group=="All" & latestIRLINK==TRUE)
    #table(temp$country)    
    #table(temp$xsurvey)    
    
nrow(dtaIR)
length(unique(dtaIR$country)) 
length(unique(dtaIR$xsurvey)) 

nsurveys<-nrow(dtaIR)
ncountries<-length(unique(dtaIR$country)) 
```

####__Women's access to contraceptive methods__ 

(Updated: `r date`)

This presents women's access to a set of contraceptive methods at SDPs that serve her community. 

* A set of five methods: __IUD, implants, injectables, pills, and male condom__.   
(__Exception in India__: Only four methods (IUD, injectables, pills, and male condom) are considered, since implants are practically not available. Inflatables is also low, but included for now)       

* __SDPs serving a community__: any SDPs (public and private) that are located in the community (i.e., EA), or any public SDPs that are designated to serve the community.    

* Five definitions of methods availability (the higher number, the darker shades in figures):   
     1. All five methods are offered     
     2. All five methods currently available    
     3. All five methods currently available + no stock out in the past 3 months for any of the five methods
     4. All five methods currently available + SDP is _ready to insert and remove_ IUD and Implants
     5. All five methods currently available + no stock out in the past 3 months for any of the five methods + SDP is _"ready" to insert and remove_ IUD and Implants
     
     ** __The order of estimates is always: 1 >= 2 >= (3 & 4) >= 5__   
     ** __The order bewtween 3 & 4 is not necessarily consistent across time and countries__.  

* __<span style="color: orange;">Orange bars/lines</span>__: __percent of SDPs__ with the 5 methods.   
* __<span style="color: blue;">Blue bars/lines</span>__: __percent of women__ who has geographic/administrative access to SDPs with the 5 methods.    

* __<span style="color: green;">For internal discussion purposes, per Scott's question - Dark green bar</span>__: percent of SDPs or women who has geographic/administrative access to SDPs with __the five methods AND additinally EC, based on the most strict definition (5)__.        

See Annexes for more info on the background and methods. 

---

####__1. Latest level__

See x-axis for the survey year. 

Interpretation example: In Kenya PMA 2018,   
* 44% of all SDPs surveyed had the five methods currently in stock.   
* But, 29% had the five methods currently available, without 3-month stockout, _and_ ready to provide them.    
* Meanwhile, at the population level, 86% of women lived in a community that was served by at least one SDP with the five methods in stock.   
* 73% of women live in a community that was served by at least one SDP that had the five methods currently available, without 3-month stockout, _and_ ready to provide them.    

_(NOTE: Population-level estimates are higher, because as long as the community is served by at least one SDPs with the 5 methods - out of roughly 3+ SDPs that are linked to the community - women are considered having access.)_      

```{r plotlevelAll, results='asis', fig.align="left", out.width="900px", out.height="700px"}
############### SDP
panel <- . %>% 
    plot_ly(x=~year, y=~essential5_offer, type = 'bar', 
                name = "offer 5 specific methods*",
                marker = list(color = '#fdd0a2'),
                text = ~essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y=~essential5_curav, type = 'bar', 
                name = "5 specific methods* available currently",
                marker = list(color = '#fdae6b'),
                text = ~essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~essential5_noso, 
                name = "5 specific methods* available currently/3-month",
                marker = list(color = '#fd8d3c'),
                text = ~essential5_noso, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~essential5_ready, 
                name = "Currently ready** to provide 5 specific methods*", 
                marker = list(color = '#f16913'),
                text = ~essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~essential5_rnoso, 
                name = "Meeting both conditions", 
                marker = list(color = '#d94801'),
                text = ~essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%   
    add_trace(y = ~essential5ec_rnoso, 
                name = "additionally with EC", 
                marker = list(color = '#31a354'),
                text = ~essential5ec_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%   
    add_annotations(
        text = ~unique(country),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 10)
        ) %>%
    layout(
        yaxis = list(title = "Percent of SDPs",
                             range = c(0, 110), tickfont = list(size=8)),
        xaxis = list(title = "Survey year", tickfont = list(size=8)), 
        showlegend = FALSE
        )

dtafig<-dtaSDP%>%filter(group=="All")%>%filter(latest==TRUE)

fig1<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareY = FALSE)%>%
    layout(showlegend = FALSE)

############### IR
panel <- . %>% 
    plot_ly(x=~year, y=~SDPall_essential5_offer, type = 'bar', 
                name = "Offer 5 specific methods*",
                marker = list(color = '#9ecae1'),
                text = ~SDPall_essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y=~SDPall_essential5_curav, type = 'bar', 
                name = "5 specific methods* available currently/3-month",
                marker = list(color = '#6baed6'),
                text = ~SDPall_essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%    
    add_trace(y = ~SDPall_essential5_noso, type = 'bar', 
                name = "5 specific methods* available currently/3-month",
                marker = list(color = '#4292c6'),
                text = ~SDPall_essential5_noso, textfont = list(size = 10) , textposition = 'outside') %>%    
    add_trace(y = ~SDPall_essential5_ready, 
                      name = "Currently ready** to provide 5 specific methods*", 
                      marker = list(color = '#2171b5'),
                      text = ~SDPall_essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~SDPall_essential5_rnoso, 
                      name = "Meeting both conditions", 
                      marker = list(color = '#084594'),
                      text = ~SDPall_essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%  
    add_trace(y = ~SDPall_essential5ec_rnoso, 
                name = "additionally with EC", 
                marker = list(color = '#31a354'),
                text = ~SDPall_essential5ec_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%   
    add_annotations(
        text = ~unique(country),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 10)
        ) %>%
    layout(
        yaxis = list(title = "Percent of all women with service environment***",
                             range = c(0, 110), tickfont = list(size=8)),
        xaxis = list(title = "Survey year", tickfont = list(size=8)),
        
        showlegend = FALSE
        )

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)

fig2<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareY = FALSE)%>%
    layout(showlegend = FALSE)

subplot(fig1, fig2, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

####__1.1 Latest level by type of SDPs__

* All SDPS vs. Lower level SDPs (excluding hospital) 

Using countries where EA-SDP linkage is relatively good for both types - [see this](https://rpubs.com/YJ_Choi/PMA_EA_SDP_Link).   

1. Availability of the methods is lower among non-hospital facilities (see first and second set of bars, both orange). 

2. Restricted to only lower-level SDPs (see second and fourth set of bars under each country), the population-level estimates (fourth set, blue bars) are again higher than SDP-level estimates (second set, orange bars).    

3. The difference between all vs. lower-level SDPs becomes larger when linked to EAs (see third vs. fourth set of bars, both blue), compared to the SDP-level estimates (first vs. second set of bars, both orange). This is clearer in Ethiopia and Uganda, even more in Rajasthan, India (especially see the difference in trends below). In other words, hospitals tend to have all five methods and also serve multiple EAs. When we exclude the hospitals, population-level access is much lower. 

__NOTE: availability based on the third definition (i.e., currently available with no 3-month stockout) exluded in below figures__
```{r plotlevelSDPtypeSDP, fig.align="left", out.width="900px", out.height="200px"}
############### SDP
panel <- . %>% 
    plot_ly(x=~year, y=~essential5_offer, type = 'bar', 
                name = "Offer 5 specific methods*",
                marker = list(color = '#fdd0a2'),
                text = ~essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(x=~year, y=~essential5_curav, 
                name = "5 specific methods* available currently",
                marker = list(color = '#fdae6b'),
                text = ~essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~essential5_ready, 
                name = "Currently ready** to provide 5 specific methods*", 
                marker = list(color = '#f16913'),
                text = ~essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~essential5_rnoso, 
                name = "Meeting both conditions", 
                marker = list(color = '#d94801'),
                text = ~essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%     
    add_trace(y = ~essential5ec_rnoso, 
                name = "additionally with EC", 
                marker = list(color = '#31a354'),
                text = ~essential5ec_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%   
    add_annotations(
        text = ~unique(group),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        yaxis = list(title = "Percent of SDPs",
                             range = c(0, 100), tickfont = list(size=8)),
        xaxis = list(title = "Survey year", tickfont = list(size=8)), 
        showlegend = FALSE
        )

dtafig<-dtaSDP%>%filter(latest==TRUE)%>%filter(country=="Burkina Faso")

figSDPBF<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaSDP%>%filter(latest==TRUE)%>%filter(country=="Ethiopia")

figSDPET<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaSDP%>%filter(latest==TRUE)%>%filter(country=="Uganda")

figSDPUG<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaSDP%>%filter(latest==TRUE)%>%filter(country=="India, Rajasthan")

figSDPRJ<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)
```

```{r plotlevelSDPtypeIRall, fig.align="left", out.width="900px", out.height="200px"}
############### IR: SDPall

panel <- . %>% 
    plot_ly(x=~year, y=~SDPall_essential5_offer, type = 'bar', 
                name = "Offer 5 specific methods*",
                marker = list(color = '#9ecae1'),
                text = ~SDPall_essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y=~SDPall_essential5_curav, type = 'bar', 
                name = "5 specific methods* available currently",
                marker = list(color = '#6baed6'),
                text = ~SDPall_essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~SDPall_essential5_ready, 
                      name = "Currently ready** to provide 5 specific methods*", 
                      marker = list(color = '#2171b5'),
                      text = ~SDPall_essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~SDPall_essential5_rnoso, 
                      name = "Meeting both conditions", 
                      marker = list(color = '#084594'),
                      text = ~SDPall_essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%  
    add_trace(y = ~SDPall_essential5ec_rnoso, 
                name = "additionally with EC", 
                marker = list(color = '#31a354'),
                text = ~SDPall_essential5ec_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%  
    add_annotations(
        text = "All",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        yaxis = list(title = "Percent of all women with service environment***",
                             range = c(0, 110), tickfont = list(size=8)),
        xaxis = list(title = "Survey year", tickfont = list(size=8)),
        
        showlegend = FALSE
        )

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Burkina Faso")

fig1BF<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Ethiopia")

fig1ET<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

fig1UG<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="India, Rajasthan")

fig1RJ<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)
```

```{r plotlevelSDPtypeIRlow, fig.align="left", out.width="900px", out.height="200px"}
############### IR: SDPlow
panel <- . %>% 
    plot_ly(x=~year, y=~SDPlow_essential5_offer, type = 'bar', 
                name = "Offer 5 specific methods*",
                marker = list(color = '#9ecae1'),
                text = ~SDPlow_essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y=~SDPlow_essential5_curav, type = 'bar', 
                name = "5 specific methods* available currently/3-month",
                marker = list(color = '#6baed6'),
                text = ~SDPlow_essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~SDPlow_essential5_ready, 
                      name = "Currently ready** to provide 5 specific methods*", 
                      marker = list(color = '#2171b5'),
                      text = ~SDPlow_essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~SDPlow_essential5_rnoso, 
                      name = "Meeting both conditions", 
                      marker = list(color = '#084594'),
                      text = ~SDPlow_essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%     
    add_trace(y = ~SDPlow_essential5ec_rnoso, 
                name = "additionally with EC", 
                marker = list(color = '#31a354'),
                text = ~SDPlow_essential5ec_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%  
    add_annotations(
        text = "Excluding hospitals",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        yaxis = list(title = "Percent of all women with service environment***",
                             range = c(0, 110), tickfont = list(size=8)),
        xaxis = list(title = "Survey year", tickfont = list(size=8)),
        
        showlegend = FALSE
        )

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Burkina Faso")

fig2BF<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Ethiopia")

fig2ET<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

fig2UG<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="India, Rajasthan")

fig2RJ<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

```

__Burkina Faso__
```{r plotlevelSDPtypeBF, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1BF, fig2BF, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPBF, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

__Ethiopia__
```{r plotlevelSDPtypeET, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1ET, fig2ET, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPET, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

__Uganda__
```{r plotlevelSDPtypeUG, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1UG, fig2UG, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPUG, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

__India, Rajasthan__
```{r plotlevelSDPtypeRJ, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1RJ, fig2RJ, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPRJ, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

```{r plotlevelOnepager, results="asis", fig.align="left", out.width="700px", out.height="350px"}
############### SDP
panel <- . %>% 
    plot_ly(x=~year, y=~essential5_offer, type = 'bar', 
                name = "",
                marker = list(color = '#fdd0a2'),
                text = ~essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(x=~year, y=~essential5_curav, 
                name = "",
                marker = list(color = '#fdae6b'),
                text = ~essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~essential5_ready, 
                name = "", 
                marker = list(color = '#f16913'),
                text = ~essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~essential5_rnoso, 
                name = "",
                marker = list(color = '#d94801'),
                text = ~essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%     
    add_annotations(
        text = "Percent of SDPs (excluding hospitals)",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        yaxis = list(title = "",
                             range = c(0, 50), tickfont = list(size=8)),
        xaxis = list(title = "", tickfont = list(size=8)),
        
        showlegend = FALSE
        )

dtafig<-dtaSDP%>%filter(latest==TRUE)%>%filter(country=="Uganda")%>%filter(group=="Excluding hospitals")

figSDPlow<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)


############### IR: SDPlow
panel <- . %>% 
    plot_ly(x=~year, y=~SDPlow_essential5_offer, type = 'bar', 
                name = "5 methods offered",
                marker = list(color = '#9ecae1'),
                text = ~SDPlow_essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y=~SDPlow_essential5_curav, type = 'bar', 
                name = "+ currently in-stock",
                marker = list(color = '#6baed6'),
                text = ~SDPlow_essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~SDPlow_essential5_ready, 
                      name = "+ a trained provider/supplies in place for inserting/removing implants and IUDs", 
                      marker = list(color = '#2171b5'),
                      text = ~SDPlow_essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~SDPlow_essential5_rnoso, 
                      name = "+ without a stock-out in the past 3 months", 
                      marker = list(color = '#084594'),
                      text = ~SDPlow_essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%     
    add_annotations(
        text = "Percent of women served by SDPs",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "(excluding hospitals) with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        yaxis = list(title = "",
                             range = c(0, 50), tickfont = list(size=8)),
        xaxis = list(title = "", tickfont = list(size=8)),
        
        legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5)
        )

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

figIRlow<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5))


subplot(figSDPlow, figIRlow, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 50), tickfont = list(size=8)) )

subplot(style(figSDPlow), 
        style(figIRlow),
        nrows=1, margin = 0.05, shareY = FALSE, titleY = TRUE
        )%>%
    layout(
        yaxis = list(range = c(0, 50), tickfont = list(size=8)), 
        legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5)
    )

```

```{r plotlevelOnepagerEC, fig.align="left", out.width="700px", out.height="350px"}
############### SDP
panel <- . %>% 
    plot_ly(x=~year, y=~essential5_offer, type = 'bar', 
                name = "Offer 5 specific methods*",
                marker = list(color = '#fdd0a2'),
                text = ~essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(x=~year, y=~essential5_curav, 
                name = "5 specific methods* available currently",
                marker = list(color = '#fdae6b'),
                text = ~essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~essential5_ready, 
                name = "Currently ready** to provide 5 specific methods*", 
                marker = list(color = '#f16913'),
                text = ~essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~essential5_rnoso, 
                name = "Meeting both conditions", 
                marker = list(color = '#d94801'),
                text = ~essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%     
    add_trace(y = ~essential5ec_rnoso, 
                name = "additionally with EC", 
                marker = list(color = '#31a354'),
                text = ~essential5ec_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%   
    add_annotations(
        text = "Percent of SDPs (excluding hospitals)",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        yaxis = list(title = "",
                             range = c(0, 50), tickfont = list(size=8)),
        xaxis = list(title = "", tickfont = list(size=8)),
        
        showlegend = FALSE
        )

dtafig<-dtaSDP%>%filter(latest==TRUE)%>%filter(country=="Uganda")%>%filter(group=="Excluding hospitals")

figSDPlow<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

############### IR: SDPlow
panel <- . %>% 
    plot_ly(x=~year, y=~SDPlow_essential5_offer, type = 'bar', 
                name = "offered",
                marker = list(color = '#9ecae1'),
                text = ~SDPlow_essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y=~SDPlow_essential5_curav, type = 'bar', 
                name = "currently available",
                marker = list(color = '#6baed6'),
                text = ~SDPlow_essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(y = ~SDPlow_essential5_ready, 
                      name = "currently available and ready to be provided", 
                      marker = list(color = '#2171b5'),
                      text = ~SDPlow_essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~SDPlow_essential5_rnoso, 
                      name = "currently available and ready to be provided, w/o stockout history", 
                      marker = list(color = '#084594'),
                      text = ~SDPlow_essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%     
    add_trace(y = ~SDPlow_essential5ec_rnoso, 
                name = "Additionally including EC, currently available and ready to be provided, w/o stockout history", 
                marker = list(color = '#31a354'),
                text = ~SDPlow_essential5ec_rnoso, textfont = list(size = 10) , textposition = 'outside') %>%  
    add_annotations(
        text = "Percent of women served by SDPs",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "(excluding hospitals) with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        yaxis = list(title = "",
                             range = c(0, 50), tickfont = list(size=8)),
        xaxis = list(title = "", tickfont = list(size=8)),
        
        legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5)
        )

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" & latestIRLINK==1)%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

figIRlow<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5))


subplot(figSDPlow, figIRlow, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 50), tickfont = list(size=8)) )

subplot(style(figSDPlow), 
        style(figIRlow),
        nrows=1, margin = 0.05, shareY = FALSE, titleY = TRUE
        )%>%
    layout(
        yaxis = list(range = c(0, 50), tickfont = list(size=8)), 
        legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5)
    )

```

####__2. Trends__

_(Note: 35 surveys used for the SDP-level data on the left/orange panel. But, only 29 surveys are used for the pop-level data on the right/blue panel, excluding earlier surveys that did not have questions for the cognitive access domain. If needed, data from the earlier surveys can be added.)_ 

```{r plottrendAll, results='asis', fig.align="left", out.width="900px", out.height="700px"}
############### SDP
panel <- . %>%
    plot_ly(x=~round, y=~essential5_offer, type = 'scatter', mode = 'lines',
            name = "offer 5 specific methods*",
            marker = list(color = '#fdd0a2'),
            line = list(color = '#fdd0a2')) %>%
    add_trace(y=~essential5_curav, type = 'scatter', mode = 'lines',
            name = "5 specific methods* available currently",
            marker = list(color = '#fdae6b'),
            line = list(color = '#fdae6b')) %>%  
    add_trace(y=~essential5_noso, type = 'scatter', mode = 'lines',
            name = "5 specific methods* available currently/3-month", 
            marker = list(color = '#fd8d3c'),
            line = list(color = '#fd8d3c')) %>%    
    add_trace(y = ~essential5_ready, type = 'scatter', mode = 'lines',
            name = "Currently ready** to provide 5 specific methods*", 
            marker = list(color = '#f16913'),
            line = list(color = '#f16913')) %>% 
    add_trace(y = ~essential5_rnoso, type = 'scatter', mode = 'lines',
            name = "Meeting both conditions", 
            marker = list(color = '#d94801'),
            line = list(color = '#d94801')) %>% 
    add_annotations(
        text = ~unique(country),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 10)
        ) %>%    
    layout(
            yaxis = list(title = "",
                         range = c(0, 110), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         range = c(1, 7), tickfont = list(size=8))
            )
        
dtafig<-dtaSDP%>%filter(group=="All") 

fig1<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareX = TRUE, shareY = TRUE)%>%
    layout(showlegend = FALSE)

############### IR

panel <- . %>%
    plot_ly(x=~round, y=~SDPall_essential5_offer, type = 'scatter', mode = 'lines',
            name = "offer 5 specific methods*", 
            marker = list(color = '#9ecae1'),
            line = list(color = '#9ecae1')) %>%
    add_trace(y=~SDPall_essential5_curav, type = 'scatter', mode = 'lines',
            name = "5 specific methods* available currently", 
            marker = list(color = '#6baed6'),
            line = list(color = '#6baed6')) %>%
    add_trace(y=~SDPall_essential5_noso, type = 'scatter', mode = 'lines',
            name = "5 specific methods* available currently/3-month", 
            marker = list(color = '#4292c6'),
            line = list(color = '#4292c6')) %>%    
    add_trace(y = ~SDPall_essential5_ready, type = 'scatter', mode = 'lines',
            name = "Currently ready** to provide 5 specific methods*", 
            marker = list(color = '#2171b5'),
            line = list(color = '#2171b5')) %>% 
    add_trace(y = ~SDPall_essential5_rnoso, type = 'scatter', mode = 'lines',
            name = "Meeting both conditions", 
            marker = list(color = '#084594'),
            line = list(color = '#084594')) %>% 
    add_annotations(
        text = ~unique(country),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 10)
        ) %>%    
    layout(
            yaxis = list(title = "",
                         range = c(0, 110), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         range = c(1, 7), tickfont = list(size=8))
            )
        
dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All")%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)

fig2<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareX = TRUE, shareY = TRUE)%>%
    layout(showlegend = FALSE)

subplot(fig1, fig2, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( showlegend = FALSE, 
            xaxis = list(title="Survey round"),
            yaxis = list(range = c(0, 110), tickfont = list(size=8))
            )
```


####__2.1 Trends by type of SDPs__

* All SDPS vs. Lower level SDPs (excluding hospitals)

Using countries where EA-SDP linkage is relatively good for both types - [see this](https://rpubs.com/YJ_Choi/PMA_EA_SDP_Link). 

__NOTE: availability based on the third definition (i.e., currently available with no 3-month stockout) exluded in below figures__

```{r plottrendSDPtypeSDP, fig.align="left", out.width="900px", out.height="200px"}
############### SDP
panel <- . %>%
    plot_ly(x=~round, y=~essential5_offer, type = 'scatter', mode = 'lines',
            name = "offer 5 specific methods*",
            marker = list(color = '#fdd0a2'),
            line = list(color = '#fdd0a2')) %>%
    add_trace(y=~essential5_curav, type = 'scatter', mode = 'lines',
            name = "5 specific methods* available currently",
            marker = list(color = '#fdae6b'),
            line = list(color = '#fdae6b')) %>%
    add_trace(y = ~essential5_ready, type = 'scatter', mode = 'lines',
              name = "Currently ready** to provide 5 specific methods*", 
              marker = list(color = '#f16913'),
              line = list(color = '#f16913')) %>% 
    add_trace(y = ~essential5_rnoso, type = 'scatter', mode = 'lines',
              name = "Meeting both conditions", 
              marker = list(color = '#d94801'),
              line = list(color = '#d94801')) %>% 
    add_annotations(
        text = ~unique(group),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%    
    layout(
            yaxis = list(title = "",
                         range = c(0, 100), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         range = c(1, 7), tickfont = list(size=8))
            )
        

dtafig<-dtaSDP%>%filter(country=="Burkina Faso")

figSDPBF<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaSDP%>%filter(country=="Ethiopia")

figSDPET<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaSDP%>%filter(country=="Uganda")

figSDPUG<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaSDP%>%filter(country=="India, Rajasthan")

figSDPRJ<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

```

```{r plottrendSDPtypeIRall, fig.align="left", out.width="900px", out.height="200px"}
############### IR: SDPany

panel <- . %>%
    plot_ly(x=~round, y=~SDPall_essential5_offer, type = 'scatter', mode = 'lines',
            name = "offer 5 specific methods*", 
            marker = list(color = '#9ecae1'),
            line = list(color = '#9ecae1')) %>%
    add_trace(y=~SDPall_essential5_curav, type = 'scatter', mode = 'lines',
            name = "5 specific methods* available currently", 
            marker = list(color = '#6baed6'),
            line = list(color = '#6baed6')) %>%
    add_trace(y = ~SDPall_essential5_ready, type = 'scatter', mode = 'lines',
              name = "Currently ready** to provide 5 specific methods*", 
              marker = list(color = '#2171b5'),
              line = list(color = '#2171b5')) %>% 
    add_trace(y = ~SDPall_essential5_rnoso, type = 'scatter', mode = 'lines',
              name = "Meeting both conditions", 
              marker = list(color = '#084594'),
              line = list(color = '#084594')) %>% 
    add_annotations(
        text = "All",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%    
    layout(
            yaxis = list(title = "",
                         range = c(0, 110), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         range = c(1, 7), tickfont = list(size=8))
            )
        

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Burkina Faso")

fig1BF<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Ethiopia")

fig1ET<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

fig1UG<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="India, Rajasthan")

fig1RJ<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)


```

```{r plottrendSDPtypeIRlow, fig.align="left", out.width="900px", out.height="200px"}
############### IR: SDP lower level 

panel <- . %>%
    plot_ly(x=~round, y=~SDPlow_essential5_offer, type = 'scatter', mode = 'lines',
            name = "Offer 5 specific methods*", 
            marker = list(color = '#9ecae1'),
            line = list(color = '#9ecae1')) %>%
    add_trace(y=~SDPlow_essential5_curav, type = 'scatter', mode = 'lines',
            name = "5 specific methods* available currently", 
            marker = list(color = '#6baed6'),
            line = list(color = '#6baed6')) %>%
    add_trace(y = ~SDPlow_essential5_ready, name = "Currently ready** to provide 5 specific methods*", 
              marker = list(color = '#2171b5'),
              line = list(color = '#2171b5')) %>% 
    add_trace(y = ~SDPlow_essential5_rnoso, name = "Meeting both conditions", 
              marker = list(color = '#084594'),
              line = list(color = '#084594')) %>% 
    add_annotations(
        text = "Excluding hospitals",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%    
    layout(
            yaxis = list(title = "",
                         range = c(0, 110), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         range = c(1, 7), tickfont = list(size=8))
            )
        
dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Burkina Faso")

fig2BF<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Ethiopia")

fig2ET<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

fig2UG<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="India, Rajasthan")

fig2RJ<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

```


__Burkina Faso__
```{r plottrendSDPtypeBF, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1BF, fig2BF, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPBF, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

__Ethiopia__
```{r plottrendSDPtypeET, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1ET, fig2ET, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPET, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

__Uganda__
```{r plottendSDPtypeUG, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1UG, fig2UG, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPUG, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

__India, Rajasthan__
```{r plottrendSDPtypeRJ, results='asis', fig.align="left", out.width="900px", out.height="200px"}
figIR<-subplot(fig1RJ, fig2RJ, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )

subplot(figSDPRJ, figIR, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 110), tickfont = list(size=8)) )
```

```{r plottrendOnepager, results="asis", fig.align="left", out.width="700px", out.height="350px"}
############### SDP
panel <- . %>%
    plot_ly(x=~yearmonth, y=~essential5_offer, type = 'scatter', mode = 'lines',
            name = "",
            marker = list(color = '#fdd0a2'),
            line = list(color = '#fdd0a2')) %>%
    add_trace(y=~essential5_curav, type = 'scatter', mode = 'lines',
            name = "",
            marker = list(color = '#fdae6b'),
            line = list(color = '#fdae6b')) %>%
    add_trace(y = ~essential5_ready, type = 'scatter', mode = 'lines',
              name = "",
              marker = list(color = '#f16913'),
              line = list(color = '#f16913')) %>% 
    add_trace(y = ~essential5_rnoso, type = 'scatter', mode = 'lines',
              name = "",
              marker = list(color = '#d94801'),
              line = list(color = '#d94801')) %>% 
    add_annotations(
        text = "Percent of SDPs (excluding hospitals)",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%    
    layout(
            yaxis = list(title = "",
                         range = c(0, 50), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         tickfont = list(size=8))
            )

dtafig<-dtaSDP%>%filter(country=="Uganda")%>%filter(group=="Excluding hospitals")

figSDPlow<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

############### IR: SDP lower level 

panel <- . %>%
    plot_ly(x=~yearmonth, y=~SDPlow_essential5_offer, type = 'scatter', mode = 'lines',
            name = "5 methods offered", 
            marker = list(color = '#9ecae1'),
            line = list(color = '#9ecae1')) %>%
    add_trace(y=~SDPlow_essential5_curav, type = 'scatter', mode = 'lines',
            name = "+ currently in-stock", 
            marker = list(color = '#6baed6'),
            line = list(color = '#6baed6')) %>%
    add_trace(y = ~SDPlow_essential5_ready, 
              name = "+ a trained provider/supplies in place for inserting/removing implants and IUDs", 
              marker = list(color = '#2171b5'),
              line = list(color = '#2171b5')) %>% 
    add_trace(y = ~SDPlow_essential5_rnoso, 
              name = "+ without a stock-out in the past 3 months", 
              marker = list(color = '#084594'),
              line = list(color = '#084594')) %>% 
    add_annotations(
        text = "Percent of women served by SDPs",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "(excluding hospitals) with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%   
    layout( legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5),
            yaxis = list(title = "",
                         range = c(0, 50), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         tickfont = list(size=8))
            )


dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

figIRlow<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout()

subplot(figSDPlow, figIRlow, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 50), tickfont = list(size=8)) )

subplot(style(figSDPlow), 
        style(figIRlow),
        nrows=1, margin = 0.05, shareY = FALSE, titleY = TRUE
        )%>%
    layout(
        yaxis = list(range = c(0, 50), tickfont = list(size=8)), 
        legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5)
    )

```

```{r plottrendOnepagerEC, fig.align="left", out.width="700px", out.height="350px"}
############### SDP
panel <- . %>%
    plot_ly(x=~yearmonth, y=~essential5_offer, type = 'scatter', mode = 'lines',
            name = "",
            marker = list(color = '#fdd0a2'),
            line = list(color = '#fdd0a2')) %>%
    add_trace(y=~essential5_curav, type = 'scatter', mode = 'lines',
            name = "",
            marker = list(color = '#fdae6b'),
            line = list(color = '#fdae6b')) %>%
    add_trace(y = ~essential5_ready, type = 'scatter', mode = 'lines',
              name = "",
              marker = list(color = '#f16913'),
              line = list(color = '#f16913')) %>% 
    add_trace(y = ~essential5_rnoso, type = 'scatter', mode = 'lines',
              marker = list(color = '#d94801'),
              line = list(color = '#d94801')) %>% 
    add_trace(y = ~essential5ec_rnoso, type = 'scatter', mode = 'lines',
              name = "",
              marker = list(color = '#31a354'),
              line = list(color = '#31a354')) %>%     
    add_annotations(
        text = "Percent of SDPs (excluding hospitals)",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%    
    layout(
            yaxis = list(title = "",
                         range = c(0, 50), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         tickfont = list(size=8))
            )

dtafig<-dtaSDP%>%filter(country=="Uganda")%>%filter(group=="Excluding hospitals")

figSDPlow<-dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout(showlegend = FALSE)

############### IR: SDP lower level 

panel <- . %>%
    plot_ly(x=~yearmonth, y=~SDPlow_essential5_offer, type = 'scatter', mode = 'lines',
            name = "offered", 
            marker = list(color = '#9ecae1'),
            line = list(color = '#9ecae1')) %>%
    add_trace(y=~SDPlow_essential5_curav, type = 'scatter', mode = 'lines',
            name = "currently available", 
            marker = list(color = '#6baed6'),
            line = list(color = '#6baed6')) %>%
    add_trace(y = ~SDPlow_essential5_ready, 
              name = "currently available and ready to be provided", 
              marker = list(color = '#2171b5'),
              line = list(color = '#2171b5')) %>% 
    add_trace(y = ~SDPlow_essential5_rnoso, 
              name = "currently available and ready to be provided, w/o stockout history", 
              marker = list(color = '#084594'),
              line = list(color = '#084594')) %>% 
    add_trace(y = ~SDPlow_essential5ec_rnoso, type = 'scatter', mode = 'lines',
              name = "Additionally including EC, currently available and ready to be provided, w/o stockout history",
              marker = list(color = '#31a354'),
              line = list(color = '#31a354')) %>%       
    add_annotations(
        text = "Percent of women served by SDPs",
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    add_annotations(
        text = "(excluding hospitals) with the 5 methods",
        x = 0.5, y = 0.91, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%   
    layout(
            yaxis = list(title = "",
                         range = c(0, 50), tickfont = list(size=8)),
            xaxis = list(title = "Survey year", 
                         tickfont = list(size=8)),
            legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5)
            )


dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(group=="All" )%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    filter(country=="Uganda")

figIRlow<-dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareY = FALSE)%>%
    layout()

subplot(figSDPlow, figIRlow, nrows=1, titleY = TRUE, margin = 0.05) %>%
    layout( 
            showlegend = FALSE, 
            yaxis = list(range = c(0, 50), tickfont = list(size=8)) )

subplot(style(figSDPlow), 
        style(figIRlow),
        nrows=1, margin = 0.05, shareY = FALSE, titleY = TRUE
        )%>%
    layout(
        yaxis = list(range = c(0, 50), tickfont = list(size=8)), 
        legend = list(font=list(size=10), 
                      orientation="v", 
                      xanchor = "left", yanchor = "center", 
                      x = 1.01, y = 0.5)
    )

```

####__3. SDP vs. Population-level metrics__ 
__Pop-based estimates of access to methods__ are always higher than __SDP-level estimates of method availability__. This section examines any pattern across countries (because of different health systems, including the role/significance of hospitals).    

Each dot represents a survey. Investigate if certain countries have high ratios, per given level of SDP-level metrics (presented on the x-axis).         

Plots to the right side has more strict definitions of access.    
* __offer__: All five methods offered        
* __curav__: All five methods currently available    
* __noso__: All five methods currently available + no stock out in the past 3 months for any of the five methods    
* __ready__: All five methods currently available + SDP is _ready to insert and remove_ IUD and Implants    
* __rnoso__: All five methods currently available + no stock out in the past 3 months for any of the five methods + SDP is _"ready" to insert and remove_ IUD and Implants   

__<span style="color: red;">Among all/any SDPs</span>__
```{r scatterplotALL, results='asis', fig.align="left", out.width="1100px", out.height="300px"}
tempSDP<-dtaSDP%>%filter(group=="All")%>%
    select(-country, -countrycode, -year, -month, -yearmonth, -cmc, -group)
    
tempIR<-dtaIR%>%filter(group=="All"& groupdemand==0)%>%
    select(-starts_with("SDPlow")) 

dtafig<-left_join(tempSDP, tempIR, by=c("xsurvey"))%>%
    filter(is.na(essential5_offer)==FALSE & is.na(SDPall_essential5_offer)==FALSE)  

layoutlist<-list(autosize = F, width = 200, height = 200, 
                 xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
                 yaxis = list(title = "Population-level",
                              range = c(0, 110), tickfont = list(size=8)),
                 showlegend=FALSE)

fig1<-dtafig%>%
    plot_ly(x = ~essential5_offer, y = ~SDPall_essential5_offer, color = ~country)%>%
    add_annotations(
        text = "offer", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig2<-dtafig%>%
    plot_ly(x = ~essential5_curav, y = ~SDPall_essential5_curav, color = ~country)%>%
    add_annotations(
        text = "curav", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig3<-dtafig%>%
    plot_ly(x = ~essential5_ready, y = ~SDPall_essential5_ready, color = ~country)%>%
    add_annotations(
        text = "ready", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig4<-dtafig%>%
    plot_ly(x = ~essential5_noso, y = ~SDPall_essential5_noso, color = ~country)%>%
    add_annotations(
        text = "noso", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig5<-dtafig%>%
    plot_ly(x = ~essential5_rnoso, y = ~SDPall_essential5_rnoso, color = ~country)%>%
    add_annotations(
        text = "rnoso", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

subplot(fig1, fig2, fig3, fig4, fig5, 
        nrows = 1, shareX = FALSE, shareY = TRUE)%>%
    layout( 
            xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
            yaxis = list(title = "Population-level",
                              range = c(0, 110), tickfont = list(size=8)),
            showlegend=FALSE)
```

```{r ratioALL, results='asis', fig.align="left", out.width="1100px", out.height="300px"}
dtafig<-dtafig%>%mutate(
    ratio_essential5_offer= SDPall_essential5_offer / essential5_offer, 
    ratio_essential5_curav= SDPall_essential5_curav / essential5_curav, 
    ratio_essential5_ready= SDPall_essential5_ready / essential5_ready, 
    ratio_essential5_noso = SDPall_essential5_noso  / essential5_noso, 
    ratio_essential5_rnoso= SDPall_essential5_rnoso / essential5_rnoso) 

layoutlist<-list(autosize = F, width = 200, height = 200, 
                 xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
                 yaxis = list(title = "Ratio",
                              tickfont = list(size=8)),
                 showlegend=FALSE)

fig1<-dtafig%>%
    plot_ly(x = ~essential5_offer, y = ~ratio_essential5_offer, color = ~country)%>%
    add_annotations(
        text = "offer", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig2<-dtafig%>%
    plot_ly(x = ~essential5_curav, y = ~ratio_essential5_curav, color = ~country)%>%
    add_annotations(
        text = "curav", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig3<-dtafig%>%
    plot_ly(x = ~essential5_ready, y = ~ratio_essential5_ready, color = ~country)%>%
    add_annotations(
        text = "ready", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig4<-dtafig%>%
    plot_ly(x = ~essential5_noso, y = ~ratio_essential5_noso, color = ~country)%>%
    add_annotations(
        text = "noso", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig5<-dtafig%>%
    plot_ly(x = ~essential5_rnoso, y = ~ratio_essential5_rnoso, color = ~country)%>%
    add_annotations(
        text = "rnoso", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

subplot(fig1, fig2, fig3, fig4, fig5, 
        nrows = 1, shareX = FALSE, shareY = TRUE)%>%
    layout( 
            xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
            yaxis = list(title = "Ratio: Pop/SDP level",
                              tickfont = list(size=8)),
            showlegend=FALSE)

```

__<span style="color: red;">Excluding hospitals: this makes sense for only select countries - probably Burkina Faso, Ethiopia, India/Rajasthan, and Uganda</span>__
```{r scatterplotLOW, results='asis', fig.align="left", out.width="1100px", out.height="300px"}
tempSDP<-dtaSDP%>%filter(group!="All")%>%
    filter(country=="Burkina Faso" | country=="Ethiopia" | country=="Uganda" | country=="India, Rajasthan")%>%
    select(-country, -countrycode, -year, -month, -yearmonth, -cmc, -group)
    
tempIR<-dtaIR%>%filter(group=="All"& groupdemand==0)%>%
    select(-starts_with("SDPall")) 

dtafig<-left_join(tempSDP, tempIR, by=c("xsurvey"))%>%
    filter(is.na(essential5_offer)==FALSE & is.na(SDPlow_essential5_offer)==FALSE)  

layoutlist<-list(autosize = F, width = 200, height = 200, 
                 xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
                 yaxis = list(title = "Population-level",
                              range = c(0, 110), tickfont = list(size=8)),
                 showlegend=FALSE)

fig1<-dtafig%>%
    plot_ly(x = ~essential5_offer, y = ~SDPlow_essential5_offer, color = ~country)%>%
    add_annotations(
        text = "offer", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig2<-dtafig%>%
    plot_ly(x = ~essential5_curav, y = ~SDPlow_essential5_curav, color = ~country)%>%
    add_annotations(
        text = "curav", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig3<-dtafig%>%
    plot_ly(x = ~essential5_ready, y = ~SDPlow_essential5_ready, color = ~country)%>%
    add_annotations(
        text = "ready", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig4<-dtafig%>%
    plot_ly(x = ~essential5_noso, y = ~SDPlow_essential5_noso, color = ~country)%>%
    add_annotations(
        text = "noso", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig5<-dtafig%>%
    plot_ly(x = ~essential5_rnoso, y = ~SDPlow_essential5_rnoso, color = ~country)%>%
    add_annotations(
        text = "rnoso", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

subplot(fig1, fig2, fig3, fig4, fig5, 
        nrows = 1, shareX = FALSE, shareY = TRUE)%>%
    layout( 
            xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
            yaxis = list(title = "Population-level",
                              range = c(0, 110), tickfont = list(size=8)),
            showlegend=FALSE)
```

```{r ratioLOW, results='asis', fig.align="left", out.width="1100px", out.height="300px"}
dtafig<-dtafig%>%mutate(
    ratio_essential5_offer= SDPlow_essential5_offer / essential5_offer, 
    ratio_essential5_curav= SDPlow_essential5_curav / essential5_curav, 
    ratio_essential5_ready= SDPlow_essential5_ready / essential5_ready, 
    ratio_essential5_noso = SDPlow_essential5_noso  / essential5_noso, 
    ratio_essential5_rnoso= SDPlow_essential5_rnoso / essential5_rnoso) 

layoutlist<-list(autosize = F, width = 200, height = 200, 
                 xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
                 yaxis = list(title = "Ratio",
                              tickfont = list(size=8)),
                 showlegend=FALSE)

fig1<-dtafig%>%
    plot_ly(x = ~essential5_offer, y = ~ratio_essential5_offer, color = ~country)%>%
    add_annotations(
        text = "offer", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig2<-dtafig%>%
    plot_ly(x = ~essential5_curav, y = ~ratio_essential5_curav, color = ~country)%>%
    add_annotations(
        text = "curav", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig3<-dtafig%>%
    plot_ly(x = ~essential5_ready, y = ~ratio_essential5_ready, color = ~country)%>%
    add_annotations(
        text = "ready", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig4<-dtafig%>%
    plot_ly(x = ~essential5_noso, y = ~ratio_essential5_noso, color = ~country)%>%
    add_annotations(
        text = "noso", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig5<-dtafig%>%
    plot_ly(x = ~essential5_rnoso, y = ~ratio_essential5_rnoso, color = ~country)%>%
    add_annotations(
        text = "rnoso", x = 0.75, y = 0.75, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

subplot(fig1, fig2, fig3, fig4, fig5, 
        nrows = 1, shareX = FALSE, shareY = TRUE)%>%
    layout( 
            xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
            yaxis = list(title = "Ratio: Pop/SDP level",
                              tickfont = list(size=8)),
            showlegend=FALSE)

```

####__4. Denominator: all women vs. women with demand__

Because this "population-level access" approach is essentially at the EA-level, there is no reason to expect any pattern by individual women's demand status. If there is any pattern, it is operated via EA-level differences in demand for FP.

Nevertheless, just in case, the following compares estimates between two denominators: all women vs. women with demand for FP. No pattern - in fact, almost identical in most cases. 

```{r plotdenominator, results='asis', fig.align="left", out.width="1000px", out.height="250px"}

library(reshape2)
dtafig<-dtaIR%>%filter(group=="All")%>%
    select(xsurvey, groupdemand, starts_with("SDPall"))%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)%>%
    mutate(
        groupdemand = as.character(groupdemand), 
        groupdemand = str_replace(groupdemand,"0","All"), 
        groupdemand = str_replace(groupdemand,"1","Demand"))%>% 
    recast(xsurvey ~ variable + groupdemand, id.var = c("xsurvey", "groupdemand"))%>%
    mutate(country = substr(xsurvey,1,nchar(xsurvey)-2))

layoutlist<-list(autosize = F, width = 200, height = 200, 
                 xaxis = list(title = "SDP-level ", 
                              range = c(0, 100), tickfont = list(size=8)), 
                 yaxis = list(title = "Population-level",
                              range = c(0, 110), tickfont = list(size=8)),
                 showlegend=FALSE)

fig1<-dtafig%>%
    plot_ly(x = ~SDPall_essential5_offer_All, y = ~SDPall_essential5_offer_Demand, color = ~country)%>%
    add_annotations(
        text = "offer", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig2<-dtafig%>%
    plot_ly(x = ~SDPall_essential5_curav_All, y = ~SDPall_essential5_curav_Demand, color = ~country)%>%
    add_annotations(
        text = "curav", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig3<-dtafig%>%
    plot_ly(x = ~SDPall_essential5_ready_All, y = ~SDPall_essential5_ready_Demand, color = ~country)%>%
    add_annotations(
        text = "ready", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig4<-dtafig%>%
    plot_ly(x = ~SDPall_essential5_noso_All, y = ~SDPall_essential5_noso_Demand, color = ~country)%>%
    add_annotations(
        text = "noso", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

fig5<-dtafig%>%
    plot_ly(x = ~SDPall_essential5_rnoso_All, y = ~SDPall_essential5_rnoso_Demand, color = ~country)%>%
    add_annotations(
        text = "rnoso", x = 0.75, y = 0.25, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "center", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(layoutlist)

subplot(fig1, fig2, fig3, fig4, fig5, 
        nrows = 1, shareX = FALSE, shareY = TRUE)%>%
    layout( 
            xaxis = list(title = "Among all women", 
                              range = c(0, 100), tickfont = list(size=8)), 
            yaxis = list(title = "Among women with demand",
                              range = c(0, 110), tickfont = list(size=8)),
            showlegend=FALSE)


```

####__5. Latest pattern by SES (only for population-based access)__

Across countries, population-level access to methods does not have a common pattern with background SES, unlike other access metrics (e.g., cognitive).  

* Often there is no significant difference.   
* There is a negative association (e.g., Uganda), potentially because of: more programming in disadvantaged areas, supply not meeting demand in areas with more users proportionately, etc.    
* In some cases, there is a positive association (e.g., Cote d'Ivoire, Kinshasa, and Niger).    

####__5.1. By education: < vs. >= ever attended secondary school__

```{r plotpattern1, results='asis', fig.align="left", out.width="900px", out.height="700px"}
panel <- . %>%
    plot_ly(x=~grouplabel, y=~SDPall_essential5_offer, type = 'bar', 
                name = "Offer 5 specific methods*", 
                marker = list(color = '#9ecae1'),
                text = ~SDPall_essential5_offer, textfont = list(size = 10) , textposition = 'outside') %>%
    add_trace(x=~grouplabel, y=~SDPall_essential5_curav, type = 'bar', 
                name = "5 specific methods* available currently", 
                marker = list(color = '#6baed6'),
                text = ~SDPall_essential5_curav, textfont = list(size = 10) , textposition = 'outside') %>%    
    add_trace(y=~SDPall_essential5_noso, type = 'bar', 
                name = "5 specific methods* available currently/3-month", 
                marker = list(color = '#4292c6'),
                text = ~SDPall_essential5_noso, textfont = list(size = 10) , textposition = 'outside') %>%    
    add_trace(y = ~SDPall_essential5_ready, 
              name = "Currently ready** to provide 5 specific methods*", 
              marker = list(color = '#2171b5'),
              text = ~SDPall_essential5_ready, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_trace(y = ~SDPall_essential5_rnoso, name = "Meeting both conditions", 
              marker = list(color = '#084594'),
              text = ~SDPall_essential5_rnoso, textfont = list(size = 10) , textposition = 'outside') %>% 
    add_annotations(
        text = ~unique(country),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 10)
        ) %>%        
    layout(
        yaxis = list(title = "Percent of all women",
                     range = c(0, 110), tickfont = list(size=8)),
        xaxis = list(title = "", tickfont = list(size=8)), 
        showlegend=FALSE
        )

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(latestIRLINK==1 & group=="Education")%>%
    filter(is.na(SDPall_essential5_noso)==FALSE)

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareY = FALSE)%>%
    layout(showlegend = FALSE, 
           title=c(""))        
```

####__5.2. By HH wealth: bottom 2 vs. top 3 quintiles__

```{r plotpattern2, results='asis', fig.align="left", out.width="900px", out.height="700px"}

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(latestIRLINK==1 & group=="HH wealth")

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareY = FALSE)%>%
    layout(showlegend = FALSE, 
           title=c(""))   
```

####__5.3. By residential area: rural vs. urban__

```{r plotpattern3, results='asis', fig.align="left", out.width="900px", out.height="700px"}

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter(latestIRLINK==1 & group=="Residential area")

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareY = FALSE)%>%
    layout(showlegend = FALSE, 
           title=c(""))  
        
```

####__6. Latest pattern of MCPR by indicator (only for population-based access)__

As expected, based on its inconsistent association with women's background characteristics, there is no common pattern with MCPR. 

MCPR (%) on the Y axis.   
* Green bar: MCPR among women __without__ access to the methods.       
* Blue bar: MCPR among women __with__ access to the methods.   

Pairs to the right side has more strict definitions of access.   
* __offer__: All five methods offered        
* __curav__: All five methods currently available    
* __noso__: All five methods currently available + no stock out in the past 3 months for any of the five methods    
* __ready__: All five methods currently available + SDP is _ready to insert and remove_ IUD and Implants    
* __rnoso__: All five methods currently available + no stock out in the past 3 months for any of the five methods + SDP is _"ready" to insert and remove_ IUD and Implants   

```{r plotmcpr, results='asis', fig.align="left", out.width="900px", out.height="700px"}

panel <- . %>%
    plot_ly(x=~group, y=~mcp, type = 'bar', 
            color = ~grouplabel
        )%>% 
    add_annotations(
        text = ~unique(country),
        x = 0.5, y = 0.8, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 10)
        ) %>%        
    layout(
        yaxis = list(title = "Percent of women in the group",
                     range = c(0, 100), tickfont = list(size=8)),
        xaxis = list(title = "", tickfont = list(size=8)), 
        showlegend = FALSE
        )

dtafig<-dtaIR%>%filter(groupdemand==0)%>%
    filter((group=="By SDPall_essential5_offer"|
            group=="By SDPall_essential5_curav"|
            group=="By SDPall_essential5_noso"|
            group=="By SDPall_essential5_ready"|
            group=="By SDPall_essential5_rnoso") & 
    latestIRLINK==1)%>%
    select(xsurvey, mcp, country, group, grouplabel)%>%
    mutate(
        group=ifelse(group=="By SDPall_essential5_offer", "offer", group),
        group=ifelse(group=="By SDPall_essential5_curav", "curav", group),
        group=ifelse(group=="By SDPall_essential5_noso", "noso", group),
        group=ifelse(group=="By SDPall_essential5_ready", "ready", group),
        group=ifelse(group=="By SDPall_essential5_rnoso", "rnoso", group)
    )

dtafig$group<-fct_relevel(
    factor(dtafig$group, levels = unique(dtafig$group)),
    c("offer", "curav", "noso", "ready", "rnoso"))
        
dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareY = FALSE, margin = 0.02)%>%
    layout(showlegend = FALSE, 
           title=c(""))  
```

---

#### Annex 1. Why link communities and SDPs? 

Informed choice of contraceptive methods is an essential principle of family planning, enabling women to choose if, when, and how many children they want to have. This choice is shaped by various dimensions of access. A necessary - though not sufficient - foundation for informed choice is if a range of methods are available to women with demand for family planning at the population level. PMA surveys provide rare information about the "population-level access to methods," thanks to its unique design to link communities and service delivery points (SDPs) that serve them. 

__1. Why not study just SDP-level data?__ Service quality at the SDP level doesn't necessarily reflect population's access to the service. Typically SDP surveys are representative of facilities in the catchment area/country. But, SDPs are more densely located in urban areas, and distribution SDPs often do not follow population distribution (see below example of Mali). In this case, facility data from this particular survey are not necessarily representative for SDPs that are accessible to the population.   

```{r figure, results="asis", fig.align="center", out.width = "600px"}
knitr::include_graphics("DIstributionOfFacilitiesAndPopulation_Mali.png")
```

__2. Why not study SDPs that were used by women?__ Most surveys do not identify exact SDPs used by respondents. One reason is, even if such SDPs can be identified accurately, they may not be representative (e.g., popular SDPs for various reasons) and data from such SDPs can be biased.    

__An alternative approach is to study SDPs that are supposed to provide service to the population__. SDP surveys in PMA are designed to cover SDPs that are either geographically or administratively linked to sampled EAs for the household/female surveys. Thus, when SDP characteristics (e.g., readiness to provide FP service) are linked to the index EAs, we can assess 'population-level accessibility to quality services', including availability of a range of methods and service readiness.    

NOTE: It is possible to have other cluster-level aggregate service quality variables using information in female surveys (e.g., cluster mean of MII among users). However, such indicators are reported only among current users. Also, if individual factors determine utilization (e.g., individual demographic and socioeconomic characteristics), rather than cluster-level factors, aggregation of information from only users may be inappropriate to understand associations between service quality and utilization (and later causality using panel data).     

---

#### Annex 2. Methods 

* For methods to link survey EAs and SDPs, see here: (https://rpubs.com/YJ_Choi/PMA_EA_SDP_Link)    
* All data come from publicly available PMA surveys. But in Burkina Faso and Niamey, Niger, the latest publicly available surveys have issues in EA-SDP linking that are currently under investigation. Thus, Burkina Faso Round 6 and Niamey Round 5 are excluded.     

---

<p style="color:gray">
See [GitHub](https://github.com/yoonjoung/PMA_Access) for data, code (for both Stata and R), and more information.   
For typos, errors, and questions, contact me at [yj.choi@isquared.global]("yj.choi@isquared.global").</p>

<p style="color:gray">
_Making Data Delicious, One Byte at a Time_</p>